<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifeinvader Ad Formatter (EN3)</title>
<style>
  :root {
    --bg: #0b0f14;         /* dark by default */
    --panel: #111821;
    --panel-2: #0e141b;
    --text: #e8eef6;
    --muted: #9bb0c3;
    --accent: #67b7ff;
    --accent-2: #8be78b;
    --danger: #ff7272;
    --warn: #ffcc66;
    --ok: #7fe7a6;
    --input: #0b121a;
    --chip: #1a2531;
    --chip-text: #cfe2f1;
    --shadow: 0 10px 35px rgba(0,0,0,.35);
  }
  .light {
    --bg: #f6f9fc;
    --panel: #ffffff;
    --panel-2: #f1f5f9;
    --text: #0f1720;
    --muted: #475569;
    --accent: #2563eb;
    --accent-2: #16a34a;
    --danger: #dc2626;
    --warn: #d97706;
    --ok: #059669;
    --input: #ffffff;
    --chip: #eef2f7;
    --chip-text: #1f2a37;
    --shadow: 0 10px 30px rgba(0,0,0,.08);
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(120deg, var(--bg), #0a0f16 60%, var(--bg));
    color: var(--text);
  }
  header {
    position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px);
    background: color-mix(in oklab, var(--bg), transparent 40%);
    border-bottom: 1px solid color-mix(in oklab, var(--text), transparent 90%);
  }
  .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }
  .row { display: grid; grid-template-columns: 1.1fr .9fr; gap: 20px; }
  .card { background: var(--panel); border: 1px solid color-mix(in oklab, var(--text), transparent 85%); border-radius: 18px; box-shadow: var(--shadow); }
  .card h2 { margin: 0; font-size: 18px; letter-spacing: .3px; color: var(--text); }
  .card .head { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 14px 16px; border-bottom: 1px dashed color-mix(in oklab, var(--text), transparent 85%); }
  .card .body { padding: 14px 16px; }
  textarea, input, select, button { font: inherit; }
  textarea, input, select { background: var(--input); color: var(--text); border: 1px solid color-mix(in oklab, var(--text), transparent 85%); border-radius: 12px; padding: 10px 12px; outline: none; }
  textarea:focus, input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent), transparent 80%); }
  textarea { width: 100%; min-height: 180px; resize: vertical; }
  .btn { border: 1px solid transparent; border-radius: 12px; padding: 9px 12px; background: var(--accent); color: white; cursor: pointer; }
  .btn.secondary { background: color-mix(in oklab, var(--accent), black 10%); }
  .btn.ghost { background: transparent; border-color: color-mix(in oklab, var(--text), transparent 85%); color: var(--text); }
  .btn.warn { background: var(--warn); color: #222; }
  .btn.danger { background: var(--danger); }
  .stack { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .grow { flex: 1; }
  .muted { color: var(--muted); font-size: 13px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius: 999px; background: var(--chip); color: var(--chip-text); font-size: 12px; }
  .list { display: grid; gap: 10px; }
  .ad { background: var(--panel-2); border: 1px solid color-mix(in oklab, var(--text), transparent 85%); border-radius: 14px; padding: 10px 12px; }
  .ad-header { display:flex; align-items:center; justify-content: space-between; gap: 10px; }
  .ad-header .tags { display:flex; gap:6px; flex-wrap:wrap; }
  .ad .text { margin: 6px 0 0 0; white-space: pre-wrap; }
  .ad .status { font-weight: 600; }
  .ok { color: var(--ok); }
  .warn-text { color: var(--warn); }
  .bad { color: var(--danger); }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .grid3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
  details { background: var(--panel-2); border-radius: 12px; padding: 6px 8px; border: 1px dashed color-mix(in oklab, var(--text), transparent 85%); }
  details > summary { cursor: pointer; color: var(--muted); }
  code.inline { background: var(--chip); color: var(--chip-text); padding: 2px 6px; border-radius: 6px; }
  .table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .table th, .table td { padding: 8px 10px; border-bottom: 1px solid color-mix(in oklab, var(--text), transparent 90%); text-align: left; }
  .kbd { border: 1px solid color-mix(in oklab, var(--text), transparent 80%); background: var(--chip); color: var(--chip-text); padding: 2px 6px; border-radius: 6px; font-size: 12px; }
  .footer { color: var(--muted); font-size: 12px; margin-top: 10px; }
  .hr { height:1px; background: color-mix(in oklab, var(--text), transparent 90%); margin: 10px 0; }
  .caps { text-transform: uppercase; letter-spacing: .08em; font-weight: 700; font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
<header>
  <div class="wrap stack" style="justify-content: space-between;">
    <div class="stack" style="gap:12px; align-items:center;">
      <h1 style="margin:0; font-size:18px;">Lifeinvader Ad Formatter <span class="muted">(EN3)</span></h1>
      <span class="pill">Night mode: <b>ON</b></span>
      <button id="themeBtn" class="btn ghost" title="Toggle theme (dark/light)">Toggle Day mode</button>
    </div>
    <div class="stack">
      <button id="exportBtn" class="btn ghost">Export config</button>
      <label class="btn ghost" for="importConfig">Import config</label>
      <input type="file" id="importConfig" accept="application/json" style="display:none" />
    </div>
  </div>
</header>

<div class="wrap" style="margin-top: 10px;">
  <div class="row">
    <!-- LEFT: INPUT -->
    <div class="card">
      <div class="head">
        <h2>Raw ads</h2>
        <div class="stack">
          <select id="splitMode">
            <option value="auto" selected>Auto-split (numbers, new lines)</option>
            <option value="line">Each line is one ad</option>
          </select>
          <button id="sampleBtn" class="btn secondary">Load sample</button>
          <button id="formatBtn" class="btn">Format</button>
        </div>
      </div>
      <div class="body">
        <textarea id="raw" placeholder="Paste raw ads here... Support for numbered lists (1-, 1), bullets, or one per line."></textarea>
        <div class="hr"></div>
        <div class="grid2">
          <div>
            <div class="caps">Reference lists</div>
            <div class="muted" style="margin:6px 0">Use these to validate car/clothing names & blacklist.</div>
            <div class="stack">
              <label class="btn ghost" for="uploadXL">Upload Cars/Clothing (.xlsx/.csv)</label>
              <input type="file" id="uploadXL" accept=".xlsx,.csv" style="display:none" />
              <label class="btn ghost" for="uploadTxt">Upload extra blacklist (.txt)</label>
              <input type="file" id="uploadTxt" accept=".txt" style="display:none" />
            </div>
            <div class="muted" style="margin-top:8px">Or paste lists:</div>
            <textarea id="manualList" placeholder="Optional: paste allowed vehicles/clothes, one per line"></textarea>
          </div>
          <div>
            <div class="caps">Output template</div>
            <div class="muted" style="margin:6px 0">Change how formatted ads look.</div>
            <textarea id="template" style="min-height:160px">{{prefix}} {{body}}{{priceOrBudget}} {{tail}}{{categoryTag}}</textarea>
            <div class="muted" style="margin-top:6px">Tokens: <code class="inline">{{prefix}}</code>, <code class="inline">{{body}}</code>, <code class="inline">{{priceOrBudget}}</code>, <code class="inline">{{tail}}</code>, <code class="inline">{{category}}</code>, <code class="inline">{{categoryTag}}</code></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="card">
      <div class="head">
        <h2>Results</h2>
        <div class="stack">
          <button id="copyAllBtn" class="btn secondary">Copy all</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>
      </div>
      <div class="body">
        <div id="stats" class="muted">No output yet.</div>
        <div class="list" id="out"></div>
      </div>
    </div>
  </div>

  <!-- RULES / EDITORS -->
  <div class="row" style="margin-top:20px; grid-template-columns: 1fr 1fr;">
    <div class="card">
      <div class="head">
        <h2>Rule editor</h2>
        <div class="stack">
          <button id="addRuleBtn" class="btn ghost">Add mapping</button>
          <button id="resetRulesBtn" class="btn warn">Reset to defaults</button>
        </div>
      </div>
      <div class="body">
        <table class="table" id="rulesTable">
          <thead>
            <tr><th>When text contains…</th><th>Change to…</th><th style="width:1%">&nbsp;</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">Mappings are case-insensitive and applied before classification/formatting.</div>
      </div>
    </div>
    <div class="card">
      <div class="head">
        <h2>Categories & limits</h2>
      </div>
      <div class="body">
        <div class="grid3">
          <div class="ad"><div class="caps">Max items (Other)</div>
            <input id="maxOther" type="number" value="3" min="1" />
          </div>
          <div class="ad"><div class="caps">Max vehicles / ad</div>
            <input id="maxVehicles" type="number" value="1" min="1" />
          </div>
          <div class="ad"><div class="caps">Rent period words</div>
            <input id="rentWords" value="per week,for,per day,days,day,week,weeks" />
          </div>
        </div>
        <details style="margin-top:10px"><summary>Blacklisted & banned (click to view/edit)</summary>
          <textarea id="blacklistBox" style="min-height:160px; margin-top:6px"></textarea>
          <div class="hr"></div>
          <div class="grid2">
            <div>
              <div class="caps">Banned party places</div>
              <textarea id="bannedPlaces" style="min-height:120px"></textarea>
            </div>
            <div>
              <div class="caps">Official places (Capitalize)</div>
              <textarea id="officialPlaces" style="min-height:120px"></textarea>
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div class="footer">
    Built for EN3 Lifeinvader editors. Dark by default, day mode available. Your changes auto‑save to this browser.
  </div>
</div>

<!-- Optional Excel reader (SheetJS). Falls back if offline. -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" integrity="sha256-QZk9zHcQ2fHnZrRuf0n7uXgV9yGX2mJ3y1GQxwhS5V8=" crossorigin="anonymous"></script>
<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const out = $('#out');
  const stats = $('#stats');
  const raw = $('#raw');
  const template = $('#template');
  const manualList = $('#manualList');
  const uploadXL = $('#uploadXL');
  const uploadTxt = $('#uploadTxt');
  const rulesTable = $('#rulesTable tbody');
  const blacklistBox = $('#blacklistBox');
  const bannedPlaces = $('#bannedPlaces');
  const officialPlaces = $('#officialPlaces');
  const splitMode = $('#splitMode');

  const defaults = {
    template: '{{prefix}} {{body}}{{priceOrBudget}} {{tail}}{{categoryTag}}',
    maxOther: 3,
    maxVehicles: 1,
    rentWords: 'per week,for,per day,days,day,week,weeks',
    blacklist: [
      'firearm','gun','pistol','ar-','ak-','ammo','ammunition','bulletproof','armor plate','weed','cannabis','cocaine','drug','ems mask','medical mask','covid mask','scanner','radar','balaclava','rope','head bag','usb with virus','lock pick','crowbar','troll','bandit mask','animal skin','satellite dish','barricade','anti-radar','engine block','air horn','grand coin','premium battlepass','battlepass','playboy', 'nationality','selling people','sexual','medkit','pills','tincture soup','license*offensive','gang hq','black market' 
    ],
    bannedPlaces: ['Mega Mall','Gang HQ','Black Market','LSPD','FIB','SAHP','EMS','Government','ghetto'],
    officialPlaces: [ 'Vinewood Hills','Rockford Hills','Richman','Sandy Shores','Paleto Bay','Postal','Hospital','Capitol','Fire Station','Auto Fair','Bahama Mamas Bar','Tequi-la-la Bar','FIB','Hotel Spa Bar','Pacific Bluffs Country Club','Diamond Resort Bar','Vanilla Unicorn Bar','Church','Stock Exchange','Stadium','Chumash','Lifeinvader','Del Perro Pier','Del Perro Beach','Cayo Perico Island','Hotel','Raton Canyon','School','SAHP' ],
    mappings: [
      ['looking to buy','buying'],['looking to purchase','buying'],['buy house','buying a house'],['buy car','buying a car'],
      ['max tuning','with full configuration'],['max config','with full configuration'],['fully upgraded','with full configuration'],
      ['lvl3','with partial configuration'],['nearly max','with partial configuration'],['level 1','low quality'],['level 2','medium quality'],['level 3','high quality'],['level 4','max quality'],
      ['body kit','with visual upgrades'],['body upgrades','with visual upgrades'],
      ['turbo','turbo kit'],['drift tuning','drift kit'],['drift assistance','drift kit'],
      ['luminous rims','luminous wheels'],['unique wheels','luminous wheels'],
      ['crates','containers'],['cases','containers'],['spray cans','paint cans'],['spray balloons','paint cans'],['extras','of type'],
      ['casino apartment','Casino penthouse'],
    ],
  };

  // Load/save state
  const state = JSON.parse(localStorage.getItem('lifmt_state')||'null') || { ...defaults };
  const save = () => localStorage.setItem('lifmt_state', JSON.stringify({
    template: template.value,
    maxOther: +$('#maxOther').value,
    maxVehicles: +$('#maxVehicles').value,
    rentWords: $('#rentWords').value,
    blacklist: textareaToList(blacklistBox.value),
    bannedPlaces: textareaToList(bannedPlaces.value),
    officialPlaces: textareaToList(officialPlaces.value),
    mappings: tableToMappings(),
  }));

  // Init UI
  template.value = state.template;
  $('#maxOther').value = state.maxOther;
  $('#maxVehicles').value = state.maxVehicles;
  $('#rentWords').value = state.rentWords;
  blacklistBox.value = state.blacklist.join('\n');
  bannedPlaces.value = state.bannedPlaces.join('\n');
  officialPlaces.value = state.officialPlaces.join('\n');
  // Mappings table
  const addRow = (a='',b='') => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input value="${escapeHtml(a)}" class="grow"/></td><td><input value="${escapeHtml(b)}" class="grow"/></td><td><button class="btn ghost del">✕</button></td>`;
    rulesTable.appendChild(tr);
    tr.querySelector('.del').onclick = () => { tr.remove(); save(); };
    tr.querySelectorAll('input').forEach(i => i.addEventListener('input', save));
  };
  (state.mappings||defaults.mappings).forEach(m => addRow(m[0], m[1]));
  $('#addRuleBtn').onclick = () => { addRow(); };
  $('#resetRulesBtn').onclick = () => { if(confirm('Reset mappings/limits/blacklists to defaults?')) { localStorage.removeItem('lifmt_state'); location.reload(); } };

  // Theme
  const themeBtn = $('#themeBtn');
  let isLight = false;
  const applyTheme = () => document.body.classList.toggle('light', isLight);
  themeBtn.onclick = () => { isLight = !isLight; applyTheme(); };
  applyTheme();

  // Import/export config
  $('#exportBtn').onclick = () => {
    const blob = new Blob([localStorage.getItem('lifmt_state')||JSON.stringify(defaults)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download: 'li-ad-formatter-config.json'});
    document.body.appendChild(a); a.click(); a.remove();
  };
  $('#importConfig').onchange = (e) => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => { try { localStorage.setItem('lifmt_state', r.result); location.reload(); } catch(err) { alert('Invalid config'); } };
    r.readAsText(f);
  };

  // Helpers
  function textareaToList(t) { return t.split(/\n+/).map(s=>s.trim()).filter(Boolean); }
  function tableToMappings() { return Array.from(rulesTable.querySelectorAll('tr')).map(tr=>Array.from(tr.querySelectorAll('input')).map(i=>i.value.trim())); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function capFirst(s){ return s.replace(/^\s*([a-z])/, (m,c)=>c.toUpperCase()); }
  const num = {
    toMoney(n){
      // format like 1.500.000 or X Million rules
      if (!isFinite(+n)) return n;
      const abs = Math.abs(+n);
      if (abs >= 1_000_000 && abs % 1_000_000 === 0) {
        return (abs/1_000_000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' Million';
      }
      return Math.round(abs).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    },
    parseMoney(raw){
      if(!raw) return null;
      let s = raw.replace(/[, ]/g,'').toLowerCase();
      s = s.replace(/(each|respectively|per|week|day|days|weeks)$/,'').trim();
      const k = /([\d.]+)k\b/.exec(s); if(k) return Math.round(parseFloat(k[1])*1000);
      const m = /([\d.]+)m\b/.exec(s); if(m) return Math.round(parseFloat(m[1])*1_000_000);
      const dm = /([\d.]+)\s*million/.exec(s); if(dm) return Math.round(parseFloat(dm[1])*1_000_000);
      const plain = s.match(/[\d.]+/g); if(plain){ return Math.round(parseFloat(plain.join(''))); }
      return null;
    }
  };

  // Classification & transformation rules (condensed)
  const RULES = {
    actions: ['buying','selling','trading','selling or trading','renting','renting out','looking'],
    categories: ['Real Estate','Auto','Business','Discounts','Work','Dating','Services','Other'],
    partyAllowed: ['house','apartment','beach','yacht','bahama mamas bar','tequi-la-la bar','stadium','diamond resort bar','arena','raton canyon','vanilla unicorn bar','hotel spa bar'],
  };

  // Dynamic references loaded by user
  let allowList = new Set();

  // File uploads for allow list & extra blacklist
  uploadXL.addEventListener('change', async (e) => {
    const f = e.target.files[0]; if(!f) return;
    if (/\.csv$/i.test(f.name)) {
      const text = await f.text();
      text.split(/\n+/).forEach(line=>{ if(line.trim()) allowList.add(line.trim()); });
    } else {
      if (!window.XLSX) { alert('XLSX library not loaded. Use CSV or paste manually.'); return; }
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws, {header:1});
      rows.flat().forEach(v => { const s = String(v||'').trim(); if(s) allowList.add(s); });
    }
    alert(`Loaded ${allowList.size} reference names.`);
  });
  uploadTxt.addEventListener('change', async (e) => {
    const f = e.target.files[0]; if(!f) return;
    const text = await f.text();
    const items = textareaToList(text);
    const cur = textareaToList(blacklistBox.value);
    blacklistBox.value = [...new Set(cur.concat(items))].join('\n');
    save();
  });

  // SAMPLE
  $('#sampleBtn').onclick = () => {
    raw.value = `1- I want to but a penthouse. My budget is 20 mil\n2- selling house 71 and 1008. Price nego\n3- buying a biz. Budget 150 mil\n4- selling state object in city.\n5- looking Anindo winslow\n6- i am a lawyer, i need work\n7- i want to plant solar\n8- sell supra, price 10 mil\n9- buying p1. Budget nego\n10- party at fib\n11- buying seed bulk. 2500 each`; };

  // MAIN: format
  $('#formatBtn').onclick = () => {
    const rules = collectRules();
    const entries = splitRaw(raw.value, splitMode.value);
    render(processAll(entries, rules));
    save();
  };
  $('#clearBtn').onclick = () => { raw.value=''; out.innerHTML=''; stats.textContent='No output yet.'; };
  $('#copyAllBtn').onclick = () => copyAll();

  function collectRules(){
    return {
      template: template.value,
      maxOther: +$('#maxOther').value,
      maxVehicles: +$('#maxVehicles').value,
      rentWords: $('#rentWords').value.split(',').map(s=>s.trim()),
      mappings: tableToMappings(),
      blacklist: new Set(textareaToList(blacklistBox.value).map(s=>s.toLowerCase())),
      bannedPlaces: textareaToList(bannedPlaces.value),
      officialPlaces: textareaToList(officialPlaces.value),
      allowList: new Set([...allowList, ...textareaToList(manualList.value)])
    };
  }

  function splitRaw(text, mode){
    if(!text.trim()) return [];
    if(mode==='line') return text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    // auto: split by numbered/bulleted lines or blank lines
    const lines = text.split(/\n+/);
    const out = []; let cur = '';
    const isStart = (s) => /^\s*(?:\d+\s*[\).\-]|[-•])\s*/.test(s);
    for(const line of lines){
      if(isStart(line) && cur){ out.push(cur.trim()); cur = line.replace(/^\s*(?:\d+\s*[\).\-]|[-•])\s*/, ''); }
      else { cur += (cur? ' ' : '') + line.replace(/^\s*(?:\d+\s*[\).\-]|[-•])\s*/, ''); }
    }
    if(cur) out.push(cur.trim());
    return out.filter(Boolean);
  }

  function applyMappings(s, mappings){
    let out = s;
    mappings.forEach(([a,b]) => {
      if(!a) return;
      out = out.replace(new RegExp(a.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), 'gi'), b);
    });
    return out;
  }

  function processAll(arr, rules){
    const results = [];
    arr.forEach((raw, idx) => {
      const r0 = raw.trim();
      let s = applyMappings(r0, rules.mappings).replace(/\s+/g,' ').trim();
      const original = s;

      // Determine action
      let action = (s.match(/\b(buying|selling or trading|selling|trading|renting out|renting|looking)\b/i)||[])[1];
      if(!action){
        if(/^looking for/i.test(s)) action = 'looking';
        else if(/^rent/i.test(s)) action = 'renting out';
        else if(/\bbuy\b|\bpurchase\b/i.test(s)) action = 'buying';
        else if(/\bsell\b/i.test(s)) action = 'selling';
      }

      // Blacklist quick check
      const blackHit = blacklistHit(s, rules.blacklist);
      if(blackHit) {
        results.push(reject(`Rejected — Cannot promote illegal/blacklisted item: "${blackHit}".`));
        return;
      }

      // Normalize price/budget strings
      const priceInfo = parsePriceOrBudget(s, action);
      s = priceInfo.cleaned;

      // Category guess & structured build
      const info = classifyAndBuild(s, action, rules, priceInfo);

      // Final template
      const prefix = capFirst(info.prefix);
      const priceOrBudget = info.priceStr ? ` ${info.priceLabel}: ${info.priceStr}` : ` ${info.priceLabel}: Negotiable`;
      const body = info.body.endsWith('.') ? info.body.slice(0,-1) : info.body; // avoid double period before price
      const tail = info.tail ? (body.endsWith('.')? '' : '.') + ' ' + info.tail : (body.endsWith('.')? '' : '.');
      const categoryTag = info.category ? ` (${info.category})` : '';
      const tpl = rules.template
        .replace(/\{\{prefix\}\}/g, prefix)
        .replace(/\{\{body\}\}/g, body)
        .replace(/\{\{priceOrBudget\}\}/g, priceOrBudget)
        .replace(/\{\{tail\}\}/g, tail)
        .replace(/\{\{category\}\}/g, info.category || '')
        .replace(/\{\{categoryTag\}\}/g, categoryTag);

      // Edge punctuation: if ends with number, remove trailing dot.
      const finalText = fixEndDot(tpl);

      results.push({ status: info.rejected ? 'Rejected' : 'OK', category: info.category, text: finalText, reasons: info.reasons, tags: info.tags });
    });
    return results;
  }

  function render(items){
    out.innerHTML = '';
    let ok=0, rej=0;
    items.forEach((it, i) => {
      if(it.status==='OK') ok++; else rej++;
      const div = document.createElement('div');
      div.className = 'ad';
      const tagEls = it.tags?.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(' ') || '';
      const reasons = it.reasons?.length ? `<div class="muted">${it.reasons.map(r=>`• ${escapeHtml(r)}`).join('<br>')}</div>` : '';
      div.innerHTML = `
        <div class="ad-header">
          <div class="status ${it.status==='OK'?'ok':'bad'}">${it.status}</div>
          <div class="tags">${tagEls}</div>
          <div class="muted">${it.category||''}</div>
        </div>
        <div class="text mono">${escapeHtml(it.text)}</div>
        ${reasons}
        <div class="stack" style="margin-top:8px; justify-content:flex-end">
          <button class="btn ghost" data-copy>Copy</button>
          <button class="btn ghost" data-delete>Delete</button>
        </div>`;
      div.querySelector('[data-copy]').onclick = () => navigator.clipboard.writeText(it.text);
      div.querySelector('[data-delete]').onclick = () => div.remove();
      out.appendChild(div);
    });
    stats.textContent = `${ok} formatted, ${rej} rejected`;
  }

  function copyAll(){
    const texts = Array.from(out.querySelectorAll('.text')).map(n=>n.textContent);
    if(!texts.length) return;
    navigator.clipboard.writeText(texts.join('\n'));
    alert('Copied all formatted ads.');
  }

  function blacklistHit(s, set){
    const low = s.toLowerCase();
    for(const w of set){
      if(w.includes('*')){ // simple wildcard prefix
        const re = new RegExp('^'+w.replace('*','.*')+'$');
        if(re.test(low)) return w;
      } else if(low.includes(w)) return w;
    }
    return null;
  }

  function parsePriceOrBudget(s, action){
    // Extract numbers and normalize, but do not force if rent/context demands.
    let price = null; let label = 'Price';
    if(/\bbudget\b/i.test(s) || /\bbuying\b/i.test(action||'')) label = 'Budget';
    if(/\b(budget|price|cost|each|respectively)\b/i.test(s)){
      const m = s.match(/\$?\s*([\d.,]+\s*(?:m|k|million)?)(?:\s*(each|respectively))?/i);
      if(m){ price = num.parseMoney(m[1]); }
    }
    // Remove raw price words for cleaner body
    const cleaned = s.replace(/\s*(price|budget)\s*[:\-]?\s*\$?[\d.,]+\s*(?:m|k|million)?\b/ig,'').replace(/\s{2,}/g,' ').trim();
    return { cleaned, price, label };
  }

  function fixEndDot(t){
    return t.replace(/\s*\.$/, (m)=>{ return /\d\.?$/.test(t.trim()) ? '' : '.'; });
  }

  function classifyAndBuild(s, action, rules, priceInfo){
    const res = { rejected:false, reasons:[], tags:[], category:null, prefix:'', body:'', tail:'', priceLabel: priceInfo.label, priceStr: priceInfo.price? ('$'+num.toMoney(priceInfo.price)) : null };

    // Normalize capitalization for leading word
    if(!action) action = 'selling';
    if(action==='looking') res.prefix = 'Looking for';
    else res.prefix = action.split(' ').map(w=>capFirst(w)).join(' ');

    // Quick category hints
    const low = s.toLowerCase();
    const isParty = /\bparty\b|wedding/.test(low);
    const isWork = /\bhiring\b|\bjob\b|looking for work|lawyer looking|dj looking|photographer|bodyguard|singer|assistant|driver/.test(low);
    const isBusiness = /store|shop|company|service station|state object|car sharing|tattoo|juice|hair salon|bar\b|jewelry|gas station|plantation|electric station|ammunition|atm\b|warehouse|freight train|chip tuning/.test(low);
    const isAuto = /".*"|\b(uber|karin|benefactor|annis|grotti|obey|pfister|toros|tundra|swift|seashark|chiron|gls600|r8|gtr|corvette|boat|helicopter|plane|motorcycle|bike|monowheel)\b/i.test(s);
    const isRealEstate = /house|apartment|penthouse|mansion|casino|garage|\bg\.s\.|w\.h\.|helipad|garden/.test(low);
    const isDiscount = /%\s*off|discount|\boff\b\s*\d+%/.test(low);

    // Dating logic (must be specific allowed phrases)
    const isDating = /^\s*looking for\b/i.test(s) && (/\b(boyfriend|girlfriend|wife|husband|family|family members|casino poker players)\b/i.test(s) || /\b[A-Z][a-z]+\s+[A-Z][a-z]+\b/.test(s));

    // Default Other
    res.category = 'Other';
    if(isParty) res.category = 'Other';
    if(isWork) res.category = 'Work';
    if(isBusiness) res.category = 'Business';
    if(isAuto) res.category = 'Auto';
    if(isRealEstate) res.category = 'Real Estate';
    if(isDiscount) res.category = 'Discounts';
    if(isDating) res.category = 'Dating';

    // Specific handlers
    switch(res.category){
      case 'Real Estate': handleRealEstate(); break;
      case 'Auto': handleAuto(); break;
      case 'Business': handleBusiness(); break;
      case 'Work': handleWork(); break;
      case 'Dating': handleDating(); break;
      case 'Discounts': handleDiscounts(); break;
      case 'Services': handleServices(); break;
      default: handleOther();
    }

    return res;

    // --- Handlers ---
    function handleRealEstate(){
      // number symbol №, features order: garden, g.s., w.h., custom interior, insurance, helipad, others, views, location
      const noMultiNum = /(house|apartment|penthouse|mansion)[^\d]*(?:№|no\.?|#)\s*(\d+)/i;
      const multi = /(\d+)\s+houses/i;
      // Normalize location capitalization
      for(const loc of rules.officialPlaces){
        const re = new RegExp(loc.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), 'i');
        s = s.replace(re, loc);
      }
      let m;
      if(multi.test(s)) { res.body = capFirst(s.replace(/price.*$/i,'').trim()); res.tags.push('Multi'); }
      else if((m = noMultiNum.exec(s))) {
        const numId = m[2];
        const type = m[1].toLowerCase().includes('apart')? 'apartment' : 'house';
        const feats = [];
        if(/garden/.test(low)) feats.push('a garden');
        const gs = s.match(/(\d{1,2})\s*(?:gs|g\.?s\.?)|\b(2|5|9|25)\s*g(?:\.?s\.?)?/i); if(gs){ feats.push(`${gs[1]||gs[2]} g.s.`); }
        const wh = s.match(/(\d)\s*w\.?h\.?/i); if(wh){ feats.push(`${wh[1]} w.h.`); }
        if(/custom interior|furnished|interior/.test(low)) feats.push('custom interior');
        if(/insurance/.test(low)) feats.push('insurance');
        if(/helipad/.test(low)) feats.push('helipad');
        if(/swimming pool/.test(low)) feats.push('swimming pool');
        if(/tennis court/.test(low)) feats.push('tennis court');
        if(/driveway/.test(low)) feats.push('long driveway');
        if(/view|views/.test(low)) feats.push('nice views');
        const loc = (s.match(/in\s+([A-Z][A-Za-z\s]+)$/)||[])[1];
        let featStr = feats.length? ` with ${feats.slice(0,-1).join(', ')}${feats.length>1?', and ':''}${feats[feats.length-1]}.` : '.';
        res.body = `Selling ${type} №${numId}${featStr}${loc? ' In '+loc+'.':''}`.replace(/\.\./g,'.');
      } else {
        // No number: add a/an before type
        const type = /apartment/.test(low)? 'an apartment' : 'a house';
        const feats = [];
        if(/garden/.test(low)) feats.push('a garden');
        const gs = s.match(/(\d{1,2})\s*(?:gs|g\.?s\.?)|\b(2|5|9|25)\s*g(?:\.?s\.?)?/i); if(gs){ feats.push(`${gs[1]||gs[2]} g.s.`); }
        const wh = s.match(/(\d)\s*w\.?h\.?/i); if(wh){ feats.push(`${wh[1]} w.h.`); }
        if(/custom interior|furnished|interior/.test(low)) feats.push('custom interior');
        if(/insurance/.test(low)) feats.push('insurance');
        if(/helipad/.test(low)) feats.push('helipad');
        const featStr = feats.length? ` with ${feats.slice(0,-1).join(', ')}${feats.length>1?', and ':''}${feats[feats.length-1]}.` : '.';
        res.body = `${capFirst(res.prefix==='Buying'?'Buying':'Selling')} ${type}${featStr}`;
      }
      res.prefix = res.prefix.startsWith('Renting')? 'Renting out' : res.prefix.split(' ')[0];
      if(/rent|per week|per day/.test(low)) res.priceLabel = res.prefix==='Renting out'? 'Rent' : res.priceLabel;
    }

    function handleAuto(){
      // Ensure quotes and order of features
      const nameMatch = s.match(/"([^"]+)"/);
      let name = nameMatch? nameMatch[1] : (s.match(/\b([A-Z][\w-]+(?:\s+[A-Z0-9][\w()\-]+)*)\b/)||[])[1] || 'car';
      // Validate against allowList if provided
      if(allowList.size && !Array.from(allowList).some(v=>v.toLowerCase()===name.toLowerCase())){
        // try to smart-capitalize common forms, otherwise keep
      }
      name = name.replace(/\s+/g,' ').trim();
      if(!/^"/.test(s)) name = `"${capFirst(name)}"`;

      const features = [];
      if(/full config|with full configuration/i.test(s) || /max tuning|fully max/i.test(s)) features.push('with full configuration');
      else if(/partial config|with partial configuration|chip|tuning/i.test(s)) features.push('with partial configuration');
      if(/visual/i.test(s)) features.push('visual upgrades');
      if(/luminous wheel|luminous rim|unique wheel|luminous wheels/i.test(s)) features.push('luminous wheels');
      if(/insurance/i.test(s)) features.push('insurance');
      if(/turbo\b/i.test(s)) features.push('turbo kit');
      if(/drift\b/i.test(s)) features.push('drift kit');
      const featStr = features.length? ` ${features[0].startsWith('with')?features[0]:('with '+features[0])}${features.slice(1).length? ', '+features.slice(1,-1).join(', ') + (features.length>1?', and ':'') + features.slice(-1):''}` : '';

      // Enforce one vehicle unless trading
      if(res.prefix.toLowerCase()==='selling or trading' || /\btrading\b/i.test(s)) {
        // OK to include two vehicles, but keep format "A" for "B"
        const trade = s.match(/for\s+"([^"]+)"/i);
        res.body = `"${name.replace(/"/g,'')}"${featStr}${trade? ` for "${trade[1]}"`:''}`;
      } else {
        res.body = `${name}${featStr}`;
      }
    }

    function handleBusiness(){
      // Normalize canonical names and numbers
      let body = s;
      body = body.replace(/(gun|weapon) store/ig,'Ammunition Store');
      body = body.replace(/barber/ig,'Hair salon');
      body = body.replace(/drug lab/ig,'Burger shop');
      // turn "№123" when any number follows a business
      body = body.replace(/(Store|shop|salon|studio|company|station|workshop|object|business)\s*(?:#|no\.?|№)?\s*(\d+)/ig, (m,kind,num)=> `${kind} №${num}`);
      res.body = capFirst(body.replace(/price.*$/i,'').trim());
    }

    function handleWork(){
      res.body = capFirst(s.replace(/\b(level|lvl)\b\s*(\d+)/ig, (m,_l,n)=> `${n} years experience`));
      res.priceLabel = /hiring|salary|awarding/i.test(s)? 'Salary' : res.priceLabel;
    }

    function handleDating(){
      // Require full name when person lookup not generic
      if(/looking for\s+[A-Za-z]+$/.test(s)){
        res.rejected = true; res.reasons.push('Please provide full first and last name.');
      }
      res.body = capFirst(s.replace(/^looking\s+for\s+/i,'Looking for '));
    }

    function handleDiscounts(){ res.body = capFirst(s); }
    function handleServices(){ res.body = capFirst(s); }

    function handleOther(){
      // Enforce max 3 items
      const commas = s.split(/,| and /i).map(x=>x.trim()).filter(Boolean);
      if(commas.length>rules.maxOther){
        res.rejected = true; res.reasons.push(`Cannot advertise more than ${rules.maxOther} items at a time.`);
      }
      // Party banned places
      if(/\bparty\b/i.test(s)){
        for(const place of rules.bannedPlaces){ if(new RegExp(place,'i').test(s)){ res.rejected=true; res.reasons.push('We do not promote this place for parties.'); break; } }
      }
      res.body = capFirst(s);
    }
  }

})();
</script>
</body>
</html>
